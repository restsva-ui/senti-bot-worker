name = "senti-bot-worker"
main = "src/index.js"
compatibility_date = "2024-09-25"
account_id = "2cf6e316af8623546c95c0354bc3aa00"

# --- CRONs ---
# 1) heartbeat кожні 15 хв (для логів/живості)
# 2) evolve щогодини рівно о :00 (UTC)
# 3) додатковий тригер нічного агента о 02:10 UTC (опційний)
[triggers]
crons = ["*/15 * * * *", "0 * * * *", "10 2 * * *"]

# --- ПУБЛІЧНІ ЗМІННІ (НЕ секрети) ---
[vars]
SERVICE_HOST = "senti-bot-worker.restsva.workers.dev"
DRIVE_FOLDER_ID = "root"
TELEGRAM_ADMIN_ID = "784869835"
DEPLOY_ID = "local-dev"

# Увімкнення/вимкнення Learn
LEARN_ENABLED = "on"

# Cloudflare Workers AI (безкоштовно через REST)
CF_ACCOUNT_ID = "2cf6e316af8623546c95c0354bc3aa00"

# ── Публічні перегляди адмін-HTML (readonly)
ALLOW_PUBLIC_REPO = "on"
ALLOW_PUBLIC_STATUT = "on"
ALLOW_PUBLIC_CHECKLIST = "on"

# Секретні токени для ендпойнтів / вебхука TG (збігаються з тим, що у CI)
WEBHOOK_SECRET = "senti1984"
TG_WEBHOOK_SECRET = "senti1984"
TELEGRAM_SECRET_TOKEN = "senti1984"

# Локальна таймзона
TIMEZONE = "Europe/Kyiv"

# Діагностичні теги
DIAG_TAGS = "on"

# ───────────────────────────────────────────────────────────────
#                МОДЕЛІ (TEXT / CODE / VISION)
# ───────────────────────────────────────────────────────────────
# Рекомендовано: спочатку швидка/дешева, далі фолбеки
MODEL_ORDER_TEXT   = "gemini:gemini-2.5-flash, cf:@cf/qwen/qwen2.5-7b-instruct, cf:@cf/meta/llama-3.1-8b-instruct, free:meta-llama/llama-4-scout:free"
MODEL_ORDER_CODE   = "cf:@cf/qwen/qwen2.5-7b-instruct, cf:@cf/meta/llama-3.1-8b-instruct, openrouter:qwen/qwen3-coder:free, free:meta-llama/llama-4-scout:free"

# VISION: тільки моделі з підтримкою зображень
VISION_ORDER       = "gemini:gemini-2.0-flash-exp, cf:@cf/meta/llama-3.2-11b-vision-instruct"
MODEL_ORDER_VISION = "gemini:gemini-2.0-flash-exp, cf:@cf/meta/llama-3.2-11b-vision-instruct"

# RUNTIME дефолт (використовується у діалозі)
MODEL_ORDER        = "gemini:gemini-2.5-flash, cf:@cf/qwen/qwen2.5-7b-instruct, cf:@cf/meta/llama-3.1-8b-instruct, free:meta-llama/llama-4-scout:free"

# --- Дефолтні моделі ---
GEMINI_MODEL    = "gemini-2.5-flash"
CF_MODEL        = "@cf/qwen/qwen2.5-7b-instruct"
CF_VISION_MODEL = "@cf/meta/llama-3.2-11b-vision-instruct"

# ───────────────────────────────────────────────────────────────
#           OpenAI-compat fallback (OpenRouter / FREE)
# ───────────────────────────────────────────────────────────────
FREE_API_BASE_URL = "https://openrouter.ai/api"
FREE_API_MODEL    = "meta-llama/llama-4-scout:free"
FREE_API_PATH     = "/v1/chat/completions"
FREE_LLM_BASE_URL = "https://openrouter.ai/api"
FREE_LLM_MODEL    = "meta-llama/llama-4-scout:free"
OPENROUTER_SITE_URL = "https://senti.restsva.app"
OPENROUTER_APP_NAME = "Senti Bot Worker"

# ───────────────────────────────────────────────────────────────
#                     VOICE (TTS / STT)
# ───────────────────────────────────────────────────────────────
# ⚠️ Щоб уникнути англомовного забарвлення — спершу MeloTTS
TTS_ORDER = "@cf/myshell-ai/melotts,@cf/deepgram/aura-1,free"

# Дефолтний голос (резерв)
VOICE_SPEAKER = "angus"

# Мапінг голосів за мовою (використовується вебхуком/voice.js)
VOICE_SPEAKER_UK = "oleksandr"
VOICE_SPEAKER_RU = "sergei"
VOICE_SPEAKER_EN = "angus"
VOICE_SPEAKER_DE = "bernd"
VOICE_SPEAKER_FR = "julie"

# Політика вибору мови озвучки:
#  - "reply_lang" → говоримо мовою відповіді (яка = мові користувача/запиту)
#  - "detect_only" → покладатися лише на авто-детект
VOICE_LANG_STRATEGY = "reply_lang"

# Озвучка за замовчуванням увімкнена
VOICE_REPLY_DEFAULT = "on"

# FREE TTS (опціонально, якщо немає кредитів на CF)
FREE_TTS_BASE_URL = ""
FREE_TTS_MODEL = "tts-1"
FREE_TTS_VOICE = "alloy"

# --- СТАБІЛІЗАТОРИ ДЛЯ STT / VISION ---
# STT: безкоштовний Gemini як fallback у спічроутері
GEMINI_STT_MODEL = "gemini-2.0-flash-exp"
# Форсований MIME для Telegram voice (ogg/opus)
FORCE_AUDIO_TYPE = "audio/ogg; codecs=opus"
# Форсований MIME для фото з Telegram (лікує application/octet-stream)
FORCE_IMAGE_TYPE = "image/jpeg"

# ───────────────────────────────────────────────────────────────
#           ВІЗУАЛ / ГЕО (для підказок і лінків на карти)
# ───────────────────────────────────────────────────────────────
# Увімкнути спроби розпізнання визначних місць у vision-відповідях
VISION_PLACE_HINT = "on"

# Шаблон лінка для карт (не потребує API ключа; підставляємо {q})
MAPS_LINK_TEMPLATE = "https://www.google.com/maps/search/?api=1&query={q}"

# ───────────────────────────────────────────────────────────────
#           UI/Меню (мʼякі налаштування кнопок у чаті)
# ───────────────────────────────────────────────────────────────
# Дозволити публічне меню з «Senti / Learn / Admin»
TELEGRAM_MENU_PUBLIC = "on"

# Максимальний розмір одного файлу в Learn (МБ)
LEARN_MAX_FILE_MB = "25"

# ───────────────────────────────────────────────────────────────
#           АВТО-ІМПРУВ / РЕГУЛЯЦІЯ / ЕНЕРГІЯ
# ───────────────────────────────────────────────────────────────
AUTO_IMPROVE = "on"
NIGHTLY_UTC_HOUR = "23"
SELF_REGULATE = "on"
SELF_TUNING_FACTOR = "0.3"

ENERGY_MAX = "100"
ENERGY_RECOVER_PER_MIN = "1"
ENERGY_COST_TEXT = "1"
ENERGY_COST_IMAGE = "5"
ENERGY_LOW_THRESHOLD = "10"

# ───────────────────────────────────────────────────────────────
#                         KV STORAGE
# ───────────────────────────────────────────────────────────────
[[kv_namespaces]]
binding = "DEDUP_KV"
id = "20d81d7b68fa4ac6b9913e2fbd3465d5"

[[kv_namespaces]]
binding = "OAUTH_KV"
id = "e2a8d3941b4e41728318781e739a4d47"

[[kv_namespaces]]
binding = "STATE_KV"
id = "7b32e2d1f60846ddb1c653eb52180bf7"

[[kv_namespaces]]
binding = "TODO_KV"
id = "497eac980691495ea2a0bc8611892d65"

[[kv_namespaces]]
binding = "USER_OAUTH_KV"
id = "470d4f5c164a4a828c569eb9a52a5133"

[[kv_namespaces]]
binding = "CHECKLIST_KV"
id = "497eac980691495ea2a0bc8611892d65"

[[kv_namespaces]]
binding = "LIKES_KV"
id = "f7d480c281ad47d2bdf270fadf4de021"

[[kv_namespaces]]
binding = "ENERGY_LOG_KV"
id = "9e6f0ed5bf2544a9a63d57455900a844"

[[kv_namespaces]]
binding = "DIALOG_KV"
id = "63c0d1e0962a419ca54082893410b28e"

[[kv_namespaces]]
binding = "LEARN_QUEUE_KV"
id = "86a54c59ce674a558780c58bf1a47dfd"

# ───────────────────────────────────────────────────────────────
#                         R2 BUCKET
# ───────────────────────────────────────────────────────────────
[[r2_buckets]]
binding = "LEARN_BUCKET"
bucket_name = "senti-learn"