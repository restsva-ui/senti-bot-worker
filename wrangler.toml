name = "senti-bot-worker"
main = "src/index.js"
compatibility_date = "2024-09-25"
account_id = "2cf6e316af8623546c95c0354bc3aa00"
workers_dev = true

[ai]
binding = "AI"

# якщо тобі треба nodejs-compat – розкоментуй
# compatibility_flags = ["nodejs_compat"]

# --- CRON-и ---
[triggers]
crons = [
  "*/15 * * * *",  # heartbeat
  "0 * * * *",     # hourly evolve / nightly agent check
  "10 2 * * *"     # додатковий нічний тригер
]

[vars]
# базові
# ВАЖЛИВО: SERVICE_HOST має бути БЕЗ https://
# бо твоя функція abs() сама додає https://
SERVICE_HOST = "senti-bot-worker.restsva.workers.dev"

DRIVE_FOLDER_ID = "root"
TELEGRAM_ADMIN_ID = "784869835"
DEPLOY_ID = "local-dev"

# увімкнення Learn (щоб адмін-сторінка й черга мали сенс)
LEARN_ENABLED = "on"

# Cloudflare Workers AI акаунт (публічний ID можна)
CF_ACCOUNT_ID = "2cf6e316af8623546c95c0354bc3aa00"

# дозволи на публічні адмін-вьюхи (ти їх у коді перевіряєш)
ALLOW_PUBLIC_REPO = "on"
ALLOW_PUBLIC_STATUT = "on"
ALLOW_PUBLIC_CHECKLIST = "on"

# сек'юрні токени ДЛЯ ВЕБХУКА й адмін-ендпойнтів
# Рекомендація: винести в secrets (але залишаю як у тебе).
WEBHOOK_SECRET = "senti1984"
TG_WEBHOOK_SECRET = "senti1984"
TELEGRAM_SECRET_TOKEN = "senti1984"

# локаль
TIMEZONE = "Europe/Kyiv"

# діагностика (щоб у відповідях показувало via …)
DIAG_TAGS = "on"

# як малювати мап-лінки з vision / landmark
MAP_LINK_STYLE = "arrow"

# щоб телега коректно відображала <a href="...">
TELEGRAM_PARSE_MODE = "HTML"

# ─────────────────────────────────────────
#            ПОРЯДКИ МОДЕЛЕЙ
# ─────────────────────────────────────────
# ТІЛЬКИ 2 провайдери: gemini -> cf
MODEL_ORDER        = "gemini:gemini-2.5-flash, gemini:gemini-1.5-flash-latest, cf:@cf/meta/llama-3.2-11b-instruct"
MODEL_ORDER_TEXT   = "gemini:gemini-2.5-flash, gemini:gemini-1.5-flash-latest, cf:@cf/meta/llama-3.2-11b-instruct"
MODEL_ORDER_CODE   = "cf:@cf/meta/llama-3.2-11b-instruct, gemini:gemini-1.5-flash-latest"
MODEL_ORDER_VISION = "gemini:gemini-2.5-flash-lite, gemini:gemini-1.5-flash-latest, cf:@cf/meta/llama-3.2-11b-vision-instruct"

# дефолтні назви моделей (для читабельності в адмінці)
GEMINI_MODEL = "gemini-2.5-flash"
CF_MODEL = "@cf/meta/llama-3.2-11b-instruct"
CF_VISION_MODEL = "@cf/meta/llama-3.2-11b-vision-instruct"

# ─────────────────────────────────────────
#     Нічні авто-поліпшення / self-reg
# ─────────────────────────────────────────
AUTO_IMPROVE     = "on"
NIGHTLY_UTC_HOUR = "23"

SELF_REGULATE      = "on"
SELF_TUNING_FACTOR = "0.3"

# ─────────────────────────────────────────
#                 ЕНЕРГІЯ
# ─────────────────────────────────────────
ENERGY_MAX = "100"
ENERGY_RECOVER_PER_MIN = "1"
ENERGY_COST_TEXT = "1"
ENERGY_COST_IMAGE = "5"
ENERGY_LOW_THRESHOLD = "10"

# ─────────────────────────────────────────
#                 KV bindings
# ─────────────────────────────────────────
[[kv_namespaces]]
binding = "DEDUP_KV"
id = "20d81d7b68fa4ac6b9913e2fbd3465d5"

[[kv_namespaces]]
binding = "OAUTH_KV"
id = "e2a8d3941b4e41728318781e739a4d47"

[[kv_namespaces]]
binding = "STATE_KV"
id = "7b32e2d1f60846ddb1c653eb52180bf7"

[[kv_namespaces]]
binding = "TODO_KV"
id = "497eac980691495ea2a0bc8611892d65"

[[kv_namespaces]]
binding = "USER_OAUTH_KV"
id = "470d4f5c164a4a828c569eb9a52a5133"

# УВАГА: зараз CHECKLIST_KV має той самий ID, що й TODO_KV.
[[kv_namespaces]]
binding = "CHECKLIST_KV"
id = "497eac980691495ea2a0bc8611892d65"

[[kv_namespaces]]
binding = "LIKES_KV"
id = "f7d480c281ad47d2bdf270fadf4de021"

# ПОВЕРНУТО: у коді використовується
[[kv_namespaces]]
binding = "ENERGY_LOG_KV"
id = "9e6f0ed5bf2544a9a63d57455900a844"

# ЗАЛИШЕНО: для Learn-черги
[[kv_namespaces]]
binding = "LEARN_QUEUE_KV"
id = "86a54c59ce674a558780c58bf1a47dfd"

# ВАЖЛИВО: DIALOG_KV ПРИБРАНО — саме його ID ("63c0d1…") у тебе не існує і валить deploy (code 10041)

# ─────────────────────────────────────────
#                 R2 buckets
# ─────────────────────────────────────────
[[r2_buckets]]
binding = "LEARN_BUCKET"
bucket_name = "senti-learn"

[[r2_buckets]]
binding = "REPO_BUCKET"
bucket_name = "senti-repo"