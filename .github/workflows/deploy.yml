name: üöÄ Deploy Worker

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üõ†Ô∏è Checkout repository
        uses: actions/checkout@v4

      - name: üß∞ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ‚öôÔ∏è Install Wrangler
        run: npm install -g wrangler@3

      - name: üöÄ Deploy to Cloudflare
        run: wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: üîñ Record snapshot after successful deploy
        if: success()
        env:
          WORKER_HOST: ${{ secrets.WORKER_HOST }}
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
        run: |
          if [ -z "$WORKER_HOST" ]; then
            echo "WORKER_HOST is empty ‚Äî skip snapshot."
            exit 0
          fi
          SNAP_URL="https://${WORKER_HOST}/postdeploy?key=${WEBHOOK_SECRET}&repo=${GITHUB_REPOSITORY}&sha=${GITHUB_SHA}"
          echo "üì¶ Sending snapshot to: https://${WORKER_HOST}/postdeploy?repo=${GITHUB_REPOSITORY}&sha=${GITHUB_SHA}"
          # –Ω–µ –≤–∞–ª–∏–º–æ –ø–∞–π–ø–ª–∞–π–Ω, —è–∫—â–æ —Å–Ω–µ–ø—à–æ—Ç –Ω–µ –≤–¥–∞–ª–æ—Å—å –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏
          curl -sS --max-time 15 "$SNAP_URL" || true