name: Deploy Cloudflare Worker (diagnostic)
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      CF_ACCOUNT_ID: "2cf6e316af8623546c95c0354bc3aa00"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Wrangler v4 + jq + curl
        run: |
          npm i -g wrangler@4
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Show project tree & wrangler.toml
        run: |
          echo "=== TREE ==="
          ls -la
          echo "=== wrangler.toml ==="
          cat wrangler.toml || true

      # 1) Перевірка валідності токена
      - name: Verify CF token (server-side)
        run: |
          set -e
          echo "Verifying token..."
          curl -sS -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            https://api.cloudflare.com/client/v4/user/tokens/verify | tee verify.json
          jq . verify.json
          OK=$(jq -r '.success' verify.json)
          if [ "$OK" != "true" ]; then
            echo "❌ Token invalid. Перевір значення CLOUDFLARE_API_TOKEN у GitHub Secrets."
            exit 1
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      # 2) Чи бачить токен потрібний акаунт
      - name: List accounts available to token
        run: |
          curl -sS -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            https://api.cloudflare.com/client/v4/accounts | tee accounts.json
          echo "=== Accounts visible to token ==="
          jq '.result[] | {id, name}' accounts.json
          MATCH=$(jq -r '.result[]?.id' accounts.json | grep -c "$CF_ACCOUNT_ID" || true)
          if [ "$MATCH" -eq 0 ]; then
            echo "❌ Токен НЕ має доступу до account_id $CF_ACCOUNT_ID (Resources → Include → Specific account)."
            exit 1
          else
            echo "✅ Token can access account $CF_ACCOUNT_ID"
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      # 3) wrangler whoami (має пройти з цим токеном і акаунтом)
      - name: Wrangler whoami
        run: |
          wrangler --version
          wrangler whoami --config wrangler.toml --account-id "$CF_ACCOUNT_ID"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      # 4) Список KV namespaceів у цьому акаунті (перевіряємо AIMAGIC_SESS id)
      - name: List KV namespaces in account
        run: |
          curl -sS -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT_ID/storage/kv/namespaces?per_page=100" \
            | tee kvns.json
          echo "=== KV namespaces (id, title) ==="
          jq '.result[] | {id, title}' kvns.json
          # Якщо хочеш перевірити конкретний ID - розкоментуй:
          # grep -q "2cbb2a8da8d547358d577524cf3eb70a" kvns.json && echo "✅ KV id matches" || echo "⚠️ KV id not found in this account"

        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      # 5) Деплой
      - name: Deploy
        run: |
          wrangler deploy --config wrangler.toml --account-id "$CF_ACCOUNT_ID" --minify --verbose
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}