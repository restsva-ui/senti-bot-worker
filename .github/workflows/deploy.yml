name: Deploy Worker

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: üõ†Ô∏è Checkout repository
        uses: actions/checkout@v4

      - name: üß∞ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ‚öôÔ∏è Install Wrangler
        run: npm install -g wrangler@3

      - name: üöÄ Deploy to Cloudflare
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: wrangler deploy

      # ‚¨áÔ∏è –∞–≤—Ç–æ–ª–æ–≥ —É —á–µ–∫–ª–∏—Å—Ç –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—é
      - name: ‚úçÔ∏è Append deploy info to senti_checklist.md
        if: success()
        env:
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }} # –¥–æ–¥–∞–π —É Secrets —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          SHA: ${{ github.sha }}
          REPO: ${{ github.repository }}
        run: |
          MSG="Deploy OK | repo=${REPO} | sha=${SHA} | run=${RUN_URL}"
          # GitHub –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –º–∞—Å–∫—É—î $WEBHOOK_SECRET —É –ª–æ–≥–∞—Ö
          curl -sS "https://senti-bot-worker.restsva.workers.dev/gdrive/log" \
            --get \
            --data-urlencode "key=${WEBHOOK_SECRET}" \
            --data-urlencode "file=senti_checklist.md" \
            --data-urlencode "msg=${MSG}"