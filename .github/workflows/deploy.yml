name: Deploy to Cloudflare Worker

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm i -g wrangler@4

      - name: Upload Worker secrets
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          set -euo pipefail
          echo "$TELEGRAM_TOKEN" | wrangler secret put TELEGRAM_TOKEN --config wrangler.toml
          echo "$WEBHOOK_SECRET" | wrangler secret put WEBHOOK_SECRET --config wrangler.toml

      - name: Deploy Worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: wrangler deploy --config wrangler.toml --minify

      # üîó –ê–≤—Ç–æ–≤–∏—Å—Ç–∞–≤–ª–µ–Ω–Ω—è –≤–µ–±—Ö—É–∫–∞ –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—é
      - name: Set Telegram webhook
        env:
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
        run: |
          set -euo pipefail
          curl -fsS "https://senti-bot-worker.restsva.workers.dev/setwebhook?secret=${WEBHOOK_SECRET}"
          echo "Webhook set successfully."
