name: Deploy Cloudflare Worker
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Wrangler v4
        run: npm i -g wrangler@4

      # Діагностика акаунта
      - name: whoami + show IDs
        run: |
          echo "CF_ACCOUNT_ID=${CF_ACCOUNT_ID}"
          wrangler --version
          wrangler whoami --account-id "${CF_ACCOUNT_ID}"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID:        ${{ secrets.CF_ACCOUNT_ID }}

      # Знайти або створити KV namespace AIMAGIC_SESS і зберегти його ID у KV_ID
      - name: Ensure KV namespace AIMAGIC_SESS
        run: |
          set -e
          wrangler kv namespace list --account-id "${CF_ACCOUNT_ID}" > kv.json
          KV_ID=$(jq -r '.[] | select(.title=="AIMAGIC_SESS" or .title=="aimagic-sess" or .title=="AIMAGIC_SESS (production)") | .id' kv.json | head -n1)
          if [ -z "$KV_ID" ]; then
            echo "KV not found → creating…"
            wrangler kv namespace create AIMAGIC_SESS --account-id "${CF_ACCOUNT_ID}" > create.txt
            KV_ID=$(grep -Eo 'id = "[a-z0-9]+"' create.txt | head -n1 | cut -d'"' -f2)
          fi
          echo "KV_ID=$KV_ID"
          echo "KV_ID=$KV_ID" >> $GITHUB_ENV
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID:        ${{ secrets.CF_ACCOUNT_ID }}

      # Патчимо wrangler.toml на льоту, щоб точно був правильний id
      - name: Patch wrangler.toml with KV_ID
        run: |
          sed -i -E 's|(binding\s*=\s*"AIMAGIC_SESS",\s*id\s*=\s*")[^"]+(")|\1'${KV_ID}'\2|' wrangler.toml
          echo "----- wrangler.toml -----"
          cat wrangler.toml

      - name: Deploy
        run: |
          wrangler deploy --account-id "${CF_ACCOUNT_ID}" --config wrangler.toml --minify --verbose
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID:        ${{ secrets.CF_ACCOUNT_ID }}