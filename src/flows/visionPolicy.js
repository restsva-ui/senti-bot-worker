// src/flows/visionPolicy.js
// ĞŸĞ¾Ğ»Ñ–Ñ‚Ğ¸ĞºĞ° Ğ´Ğ»Ñ vision-Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´ĞµĞ¹ Senti Ğ· Ğ¿Ñ–Ğ´Ñ‚Ñ€Ğ¸Ğ¼ĞºĞ¾Ñ ĞºÑ–Ğ»ÑŒĞºĞ¾Ñ… Ğ¼Ğ¾Ğ².

const BASE_RULES = `
ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ:
- ĞŸĞ¸ÑˆĞ¸ Ğ»Ğ°ĞºĞ¾Ğ½Ñ–Ñ‡Ğ½Ğ¾: 1â€“2 Ñ€ĞµÑ‡ĞµĞ½Ğ½Ñ Ğ¾Ğ¿Ğ¸ÑÑƒ + (Ğ·Ğ° Ğ½Ğ°ÑĞ²Ğ½Ğ¾ÑÑ‚Ñ–) ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ„Ğ°ĞºÑ‚Ñ–Ğ².
- Ğ—Ñ€Ğ¾Ğ±Ğ¸ OCR. Ğ¯ĞºÑ‰Ğ¾ Ğ½Ğ° Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ– Ğ„ Ñ‚ĞµĞºÑÑ‚ â€” Ğ½Ğ°Ğ²ĞµĞ´Ğ¸ Ğ¹Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ÑĞ»Ñ–Ğ²Ğ½Ğ¾ Ğ² Ğ»Ğ°Ğ¿ĞºĞ°Ñ… Ğ¾ĞºÑ€ĞµĞ¼Ğ¸Ğ¼ Ñ€ÑĞ´ĞºĞ¾Ğ¼.
- Ğ¯ĞºÑ‰Ğ¾ Ñ‚ĞµĞºÑÑ‚Ñƒ Ğ½ĞµĞ¼Ğ°Ñ” Ğ°Ğ±Ğ¾ Ğ²Ñ–Ğ½ Ğ½ĞµÑ€Ğ¾Ğ·Ğ±Ñ–Ñ€Ğ»Ğ¸Ğ²Ğ¸Ğ¹ â€” Ğ²Ğ·Ğ°Ğ³Ğ°Ğ»Ñ– Ğ½Ğµ Ğ·Ğ³Ğ°Ğ´ÑƒĞ¹ Ğ¿Ñ€Ğ¾ Ñ‚ĞµĞºÑÑ‚.
- Ğ‘Ñ€ĞµĞ½Ğ´Ğ¸/Ğ¼Ğ¾Ğ´ĞµĞ»Ñ– Ğ½Ğ°Ğ·Ğ¸Ğ²Ğ°Ğ¹ Ğ»Ğ¸ÑˆĞµ ÑĞºÑ‰Ğ¾ Ğ²Ğ¸Ğ´Ğ½Ğ¾ Ğ»Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿ Ğ°Ğ±Ğ¾ Ğ½Ğ°Ğ·Ğ²Ñƒ; Ñ–Ğ½Ğ°ĞºÑˆĞµ â€” "ĞĞµ Ğ²Ğ¿ĞµĞ²Ğ½ĞµĞ½Ğ¸Ğ¹".
- Ğ¯ĞºÑ‰Ğ¾ ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡ Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ğ² Ğ¿Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ â€” Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ°Ğ¹ ÑĞ°Ğ¼Ğµ Ğ½Ğ° Ğ½ÑŒĞ¾Ğ³Ğ¾. Ğ¯ĞºÑ‰Ğ¾ Ğ´Ğ°Ğ½Ğ¸Ñ… Ğ±Ñ€Ğ°ĞºÑƒÑ” â€” â€œĞĞµ Ğ²Ğ¿ĞµĞ²Ğ½ĞµĞ½Ğ¸Ğ¹â€.
- ĞĞµ Ğ²Ğ¸Ğ³Ğ°Ğ´ÑƒĞ¹ Ñ‚ĞµÑ…Ğ½Ñ–Ñ‡Ğ½Ñ– Ñ…Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ Ñ‡Ğ¸ Ğ´Ğ¶ĞµÑ€ĞµĞ»Ğ°.
Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ñ– (Ñ„Ğ¾Ğ»Ğ±ĞµĞº):
ğŸ–¼ï¸ ĞšĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹ Ğ¾Ğ¿Ğ¸Ñ (1â€“2 Ñ€ĞµÑ‡ĞµĞ½Ğ½Ñ).
â“ Ğ’Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´ÑŒ Ğ½Ğ° Ğ¿Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ (ÑĞºÑ‰Ğ¾ Ğ±ÑƒĞ»Ğ¾).
âš ï¸ ĞŸÑ€Ğ¸Ğ¼Ñ–Ñ‚ĞºĞ° Ğ²Ğ¿ĞµĞ²Ğ½ĞµĞ½Ğ¾ÑÑ‚Ñ– (Ğ¾Ğ¿Ñ†Ñ–Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾).
`.trim();

const HINTS = {
  uk: `Ğ¢Ğ¸ â€” Senti. ĞĞ¿Ğ¸ÑÑƒĞ¹ Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ ÑƒĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ¾Ñ. ${BASE_RULES}`,
  en: `You are Senti. Describe the image in English. ${BASE_RULES}`,
  ru: `Ğ¢Ñ‹ â€” Senti. ĞĞ¿Ğ¸ÑˆĞ¸ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾-Ñ€ÑƒÑÑĞºĞ¸. ${BASE_RULES}`,
  de: `Du bist Senti. Beschreibe das Bild auf Deutsch. ${BASE_RULES}`,
};

export function buildVisionHintByLang(langCode) {
  const lc = String(langCode || "").toLowerCase();
  if (lc.startsWith("uk") || lc === "ua") return HINTS.uk;
  if (lc.startsWith("ru")) return HINTS.ru;
  if (lc.startsWith("de")) return HINTS.de;
  return HINTS.en;
}

export function makeVisionUserPrompt(question, lang = "uk") {
  const q = String(question || "").trim();
  if (!q) {
    return lang.startsWith("en")
      ? "Describe the image. If there is visible text, quote it verbatim on a separate line."
      : "ĞĞ¿Ğ¸ÑˆĞ¸ Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ. Ğ¯ĞºÑ‰Ğ¾ Ñ” Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ğ¸Ğ¹ Ñ‚ĞµĞºÑÑ‚ â€” Ğ½Ğ°Ğ²ĞµĞ´Ğ¸ Ğ¹Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ÑĞ»Ñ–Ğ²Ğ½Ğ¾ Ğ² Ğ»Ğ°Ğ¿ĞºĞ°Ñ… Ğ¾ĞºÑ€ĞµĞ¼Ğ¸Ğ¼ Ñ€ÑĞ´ĞºĞ¾Ğ¼.";
  }
  return lang.startsWith("en")
    ? `User asks: "${q}". Answer based on the image.`
    : `ĞšĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡ Ğ¿Ğ¸Ñ‚Ğ°Ñ”: "${q}". Ğ’Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ°Ğ¹ Ğ·Ğ° Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½ÑĞ¼.`;
}

export function postprocessVisionText(text) {
  let t = String(text || "").trim();
  // Ğ¿Ñ€Ğ¸Ğ±Ğ¸Ñ€Ğ°Ñ”Ğ¼Ğ¾ ÑĞ»ÑƒĞ¶Ğ±Ğ¾Ğ²Ñ– Ğ¿Ñ–Ğ´Ğ¿Ğ¸ÑĞ¸ Ñ‚Ğ¸Ğ¿Ñƒ "via ..."
  t = t.replace(/^[ \t]*(?:â€”|--)?\s*via\s+[^\n]*\n?/gim, "").trim();
  // Ğ½Ğµ Ğ±Ñ–Ğ»ÑŒÑˆĞµ 4 Ñ€ÑĞ´ĞºÑ–Ğ²
  const lines = t.split(/\n+/).filter(Boolean);
  if (lines.length > 4) t = lines.slice(0, 4).join("\n");
  return t;
}
